<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch Together - Sign In</title>
    <meta name="description" content="Sign in to Watch Together - Share videos and chat with friends in real-time">
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Modern Typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé¨</text></svg>">
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="css/login.css">
    
</head>
<body>
    <div class="auth-container">
        <div class="welcome-section">
            <div class="welcome-content">
                <h1>
                    <div class="welcome-icon">
                        <i class="fas fa-play"></i>
                    </div>
                    Watch Together
                </h1>
                <p>Share videos and chat with friends in real-time</p>
                <div class="features-grid">
                    <div class="feature-item">
                        <i class="fas fa-video"></i>
                        <div>
                            <h4>Watch Together</h4>
                            <p>Synchronized video playback for everyone</p>
                        </div>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-comments"></i>
                        <div>
                            <h4>Real-time Chat</h4>
                            <p>Chat and voice communication</p>
                        </div>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-sync"></i>
                        <div>
                            <h4>Multiple Sources</h4>
                            <p>YouTube, Vimeo, and direct videos</p>
                        </div>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-crown"></i>
                        <div>
                            <h4>Take Control</h4>
                            <p>Pass control between friends</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="form-section">
            <div class="form-container">
                <div class="tab-container">
                    <button class="tab-button active" onclick="switchTab('login')">
                        <i class="fas fa-sign-in-alt"></i> Sign In
                    </button>
                    <button class="tab-button" onclick="switchTab('register')">
                        <i class="fas fa-user-plus"></i> Sign Up
                    </button>
                </div>

                <div class="error-message" id="error-message"></div>
                <div class="success-message" id="success-message"></div>

                <!-- Login Form -->
                <form id="login-form" style="display: block;">
                    <div class="form-group">
                        <label for="login-username">Username or Email</label>
                        <input type="text" id="login-username" name="usernameOrEmail" placeholder="Enter your username or email" required maxlength="50">
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password</label>
                        <input type="password" id="login-password" name="password" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="submit-button">
                        <i class="fas fa-sign-in-alt"></i>
                        Sign In
                    </button>
                    
                    <div class="divider">
                        <span>or</span>
                    </div>
                    
                    <button type="button" class="google-button" onclick="signInWithGoogle()">
                        <i class="fab fa-google"></i>
                        Sign in with Google
                    </button>
                </form>

                <!-- Register Form -->
                <form id="register-form" style="display: none;">
                    <div class="form-group">
                        <label for="register-username">Display Name</label>
                        <input type="text" id="register-username" name="username" placeholder="Choose a display name" required maxlength="20">
                    </div>
                    <div class="form-group">
                        <label for="register-email">Email Address</label>
                        <input type="email" id="register-email" name="email" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="register-password">Password</label>
                        <input type="password" id="register-password" name="password" placeholder="Create a password" required minlength="6">
                    </div>
                    <button type="submit" class="submit-button">
                        <i class="fas fa-user-plus"></i>
                        Create Account
                    </button>
                </form>

                <!-- Forgot Password Form -->
                <form id="forgot-password-form" style="display: none;">
                    <div class="form-header">
                        <h3>
                            <i class="fas fa-key"></i>
                            Reset Your Password
                        </h3>
                        <p>Enter your username or email address and we'll send you a link to reset your password.</p>
                    </div>
                    <div class="form-group">
                        <label for="forgot-identifier">Username or Email</label>
                        <input type="text" id="forgot-identifier" name="usernameOrEmail" placeholder="Enter your username or email" required>
                    </div>
                    <button type="submit" class="submit-button">
                        <i class="fas fa-paper-plane"></i>
                        Send Reset Link
                    </button>
                    <div class="back-to-login">
                        <a href="#" onclick="showLogin()">
                            <i class="fas fa-arrow-left"></i> Back to Sign In
                        </a>
                    </div>
                </form>
<!-- 
                <button type="button" class="guest-button" onclick="continueAsGuest()">
                    <i class="fas fa-user-secret"></i>
                    Continue as Guest
                </button> -->

                <div class="auth-links">
                    <a href="/reset-password.html">Forgot Password?</a> ‚Ä¢ 
                    <a href="/">‚Üê Back to Watch Room</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check for URL parameters for error messages
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');
            
            if (error === 'google_not_configured') {
                showError('Google Sign-In is not configured on this server. Please use email/password login.');
            } else if (error === 'oauth_failed') {
                showError('Google Sign-In failed. Please try again or use email/password login.');
            }
        });

        function switchTab(tab) {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const forgotPasswordForm = document.getElementById('forgot-password-form');
            const tabButtons = document.querySelectorAll('.tab-button');

            // Clear any error/success messages
            hideMessage();

            // Hide all forms first
            loginForm.style.display = 'none';
            registerForm.style.display = 'none';
            forgotPasswordForm.style.display = 'none';

            if (tab === 'login') {
                loginForm.style.display = 'block';
                tabButtons[0].classList.add('active');
                tabButtons[1].classList.remove('active');
            } else {
                registerForm.style.display = 'block';
                tabButtons[0].classList.remove('active');
                tabButtons[1].classList.add('active');
            }
        }

        function showForgotPassword() {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const forgotPasswordForm = document.getElementById('forgot-password-form');
            const tabButtons = document.querySelectorAll('.tab-button');

            // Clear any error/success messages
            hideMessage();

            // Hide all forms and show forgot password form
            loginForm.style.display = 'none';
            registerForm.style.display = 'none';
            forgotPasswordForm.style.display = 'block';
            
            // Remove active state from all tabs
            tabButtons.forEach(btn => btn.classList.remove('active'));
        }

        function showLogin() {
            switchTab('login');
        }

        function showError(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            document.getElementById('success-message').style.display = 'none';
        }

        function showSuccess(message) {
            const successElement = document.getElementById('success-message');
            successElement.textContent = message;
            successElement.style.display = 'block';
            document.getElementById('error-message').style.display = 'none';
        }

        function hideMessage() {
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('success-message').style.display = 'none';
        }

        function continueAsGuest() {
            // Redirect to main page as guest
            window.location.href = '/';
        }

        function signInWithGoogle() {
            // Check if Google OAuth is configured by making a test request
            fetch('/api/auth/google', {
                method: 'HEAD',
                redirect: 'manual'
            }).then(response => {
                if (response.type === 'opaqueredirect' || response.status === 302) {
                    // Google OAuth is configured, redirect to it
                    window.location.href = '/api/auth/google';
                } else {
                    // Google OAuth is not configured
                    showError('Google Sign-In is not configured. Please use email/password login or contact the administrator.');
                }
            }).catch(error => {
                // Fallback: try direct redirect (for backward compatibility)
                window.location.href = '/api/auth/google';
            });
        }

        // Handle login form submission
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (response.ok) {
                    // Store authentication data
                    localStorage.setItem('authToken', result.token);
                    localStorage.setItem('userData', JSON.stringify(result.user));
                    localStorage.removeItem('guestMode'); // Clear guest mode if set
                    
                    showSuccess('Login successful! Redirecting...');
                    
                    // Check if there's a specific return URL (only from URL params, not localStorage)
                    const urlParams = new URLSearchParams(window.location.search);
                    const returnUrl = urlParams.get('returnUrl');
                    
                    // Clean up any stored pre-login URL
                    localStorage.removeItem('preLoginUrl');
                    
                    // Default to home page unless there's an explicit returnUrl parameter
                    const redirectUrl = returnUrl || '/home.html';
                    
                    // Debug logging
                    console.log('Login redirect debug:');
                    console.log('  Current URL:', window.location.href);
                    console.log('  URL params returnUrl:', returnUrl);
                    console.log('  Final redirect URL:', redirectUrl);
                    
                    setTimeout(() => {
                        window.location.href = redirectUrl;
                    }, 1500);
                } else {
                    showError(result.message || result.error || 'Login failed');
                }
            } catch (error) {
                showError('Network error. Please try again.');
            }
        });

        // Handle register form submission
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (response.ok) {
                    // Store authentication data
                    localStorage.setItem('authToken', result.token);
                    localStorage.setItem('userData', JSON.stringify(result.user));
                    localStorage.removeItem('guestMode'); // Clear guest mode if set
                    
                    showSuccess('Account created successfully! Redirecting...');
                    
                    // Check if there's a specific return URL (only from URL params, not localStorage)
                    const urlParams = new URLSearchParams(window.location.search);
                    const returnUrl = urlParams.get('returnUrl');
                    
                    // Clean up any stored pre-login URL
                    localStorage.removeItem('preLoginUrl');
                    
                    // Default to home page unless there's an explicit returnUrl parameter
                    const redirectUrl = returnUrl || '/home.html';
                    
                    // Debug logging
                    console.log('Register redirect debug:');
                    console.log('  Current URL:', window.location.href);
                    console.log('  URL params returnUrl:', returnUrl);
                    console.log('  Final redirect URL:', redirectUrl);
                    
                    setTimeout(() => {
                        window.location.href = redirectUrl;
                    }, 1500);
                } else {
                    showError(result.message || result.error || 'Registration failed');
                }
            } catch (error) {
                showError('Network error. Please try again.');
            }
        });

        // Handle forgot password form submission
        document.getElementById('forgot-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            try {
                const response = await fetch('/api/auth/forgot-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (response.ok) {
                    showSuccess(result.message || 'Password reset email sent! Check your inbox.');
                    // Clear the form
                    document.getElementById('forgot-identifier').value = '';
                } else {
                    showError(result.message || result.error || 'Failed to send reset email');
                }
            } catch (error) {
                showError('Network error. Please try again.');
            }
        });
    </script>
</body>
</html>
